# Created by: Wes Peters <wes@FreeBSD.org>

PORTNAME=	poco
DISTVERSION=	1.10.1
DISTVERSIONSUFFIX=	-all
CATEGORIES=	devel net
MASTER_SITES=	https://pocoproject.org/releases/${PORTNAME}-${PORTVERSION}/

MAINTAINER=	henry.hu.sh@gmail.com
COMMENT=	C++ libraries with a network/internet focus

LICENSE=	BSL
LICENSE_FILE=	${WRKSRC}/LICENSE

LIB_DEPENDS=	libpcre.so:devel/pcre \
		libexpat.so:textproc/expat2

USES=		cmake compiler:c++14-lang cpe localbase pkgconfig tar:bz2
USE_LDCONFIG=	yes

CONFLICTS=	poco-ssl-[0-9]*

CPE_VENDOR=	pocoproject

CMAKE_ARGS=	-DPOCO_UNBUNDLED:BOOL=ON
SHLIB_MAJOR=	71
PLIST_SUB=	SHLIB_MAJOR=${SHLIB_MAJOR}

OPTIONS_DEFINE=		MYSQL REDIS SQLITE SSL TEST
OPTIONS_RADIO=		ODBC
OPTIONS_RADIO_ODBC=	IODBC UNIXODBC
OPTIONS_DEFAULT=	MYSQL REDIS SQLITE SSL
OPTIONS_SUB=		yes

MYSQL_USES=		mysql
MYSQL_CMAKE_OFF=	-DENABLE_DATA_MYSQL:BOOL=OFF
IODBC_LIB_DEPENDS=	libiodbc.so:databases/libiodbc
IODBC_CMAKE_ON=		-DODBC_INCLUDE_DIRECTORIES:PATH=${LOCALBASE}/include/libiodbc \
			-DODBC_LIBRARIES:FILEPATH=${LOCALBASE}/lib/libiodbc.so
SQLITE_USES=		sqlite
SQLITE_CMAKE_OFF=	-DENABLE_DATA_SQLITE:BOOL=OFF
SSL_USES=		ssl
SSL_CMAKE_OFF=		-DENABLE_CRYPTO:BOOL=OFF \
			-DENABLE_NETSSL:BOOL=OFF
UNIXODBC_LIB_DEPENDS=	libodbc.so:databases/unixODBC
UNIXODBC_CMAKE_ON=	-DODBC_INCLUDE_DIRECTORIES:PATH=${LOCALBASE}/include \
			-DODBC_LIBRARIES:FILEPATH=${LOCALBASE}/lib/libodbc.so
TEST_CMAKE_ON=		-DENABLE_TESTS:BOOL=ON
TEST_IMPLIES=		SQLITE SSL
TEST_TEST_TARGET=	test
REDIS_CMAKE_OFF=	-DENABLE_REDIS:BOOL=OFF

.include <bsd.port.options.mk>

.if ${PORT_OPTIONS:MMYSQL} || ${PORT_OPTIONS:MSQLITE} || ${PORT_OPTIONS:MIODBC} || ${PORT_OPTIONS:MUNIXODBC}
PLIST_SUB+=	DATA=""
.else
PLIST_SUB+=	DATA="@comment "
.endif

.if ${PORT_OPTIONS:MIODBC} || ${PORT_OPTIONS:MUNIXODBC}
PLIST_SUB+=	ODBC=""
.else
CMAKE_ARGS+=	-DENABLE_DATA_ODBC:BOOL=OFF
PLIST_SUB+=	ODBC="@comment "
.endif

post-patch:
	@${REINPLACE_CMD} -e \
		's|-D_XOPEN_SOURCE=500 || ; \
		 s|_EPOLL|_POLL| ; \
		 s|CMAKE_DEBUG_POSTFIX "d"|CMAKE_DEBUG_POSTFIX ""| ; \
		 s|dl rt|rt|' ${WRKSRC}/cmake/DefinePlatformSpecifc.cmake

.include <bsd.port.mk>
