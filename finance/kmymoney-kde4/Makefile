# $FreeBSD$

PORTNAME=	kmymoney
PORTVERSION=	4.8.2
PORTREVISION=	3
CATEGORIES=	finance kde
MASTER_SITES=	KDE/stable/${PORTNAME}/${PORTVERSION}/src
PKGNAMESUFFIX=	-kde4

MAINTAINER=	jhale@FreeBSD.org
COMMENT=	KDE4 personal finance manager

LICENSE=	GPLv2+
LICENSE_FILE=	${WRKSRC}/COPYING

DEPRECATED=	KDE4 is EOL upstream. Use finance/kmymoney instead
EXPIRATION_DATE=	2018-12-31

LIB_DEPENDS=	libboost_graph.so:devel/boost-libs \
		libalkimia.so:finance/alkimia-qt4 \
		libgpgme.so:security/gpgme \
		libassuan.so:security/libassuan \
		libgpg-error.so:security/libgpg-error

USES=		cmake kde:4 pkgconfig qt:4 shared-mime-info shebangfix tar:xz
USE_QT=		corelib gui dbus declarative network phonon script sql svg xml \
		qmake_build moc_build rcc_build uic_build
USE_KDE=	automoc4 kdelibs pimlibs soprano
USE_LDCONFIG=	yes

# Crash occurs when built with Gpgmepp instead of Qgpgme and trying to
# configure encryption:
# Settings -> Configure KMyMoney... -> Encryption
CMAKE_ON=	CMAKE_DISABLE_FIND_PACKAGE_Gpgmepp

CONFLICTS_INSTALL=	kmymoney

SHEBANG_FILES=	kmymoney/misc/financequote.pl

OPTIONS_GROUP=		PLUGINS
OPTIONS_GROUP_PLUGINS=	CALENDAR KBANKING OFX WEBOOB
OPTIONS_DEFINE=		NLS QUOTES
OPTIONS_DEFAULT=	CALENDAR KBANKING OFX QUOTES
OPTIONS_SUB=		yes

NLS_USES=		gettext
NLS_CMAKE_BOOL=		BUILD_po

CALENDAR_DESC=		iCalendar exporter
CALENDAR_LIB_DEPENDS=	libical.so:devel/libical
CALENDAR_CMAKE_BOOL=	ENABLE_LIBICAL

KBANKING_DESC=		Online banking via KBanking (AqBanking)
KBANKING_LIB_DEPENDS=	libgwenhywfar.so:devel/gwenhywfar \
			libgwengui-qt4.so:devel/gwenhywfar-qt4 \
			libaqbanking.so:finance/aqbanking
KBANKING_CMAKE_BOOL=	ENABLE_KBANKING

OFX_DESC=		OFX (Open Financial Exchange) importer
OFX_LIB_DEPENDS=	libofx.so:finance/libofx
OFX_CMAKE_BOOL=		ENABLE_LIBOFX

QUOTES_DESC=		Online stock and currency price quotes
QUOTES_RUN_DEPENDS=	p5-Date-Manip>=0:devel/p5-Date-Manip \
			p5-Finance-Quote>=0:finance/p5-Finance-Quote \
			p5-XML-Parser>=0:textproc/p5-XML-Parser \
			p5-XML-Writer>=0:textproc/p5-XML-Writer \
			p5-libwww>=0:www/p5-libwww
QUOTES_USES=		perl5
QUOTES_USE=		PERL5=run

WEBOOB_DESC=		Online banking via Web Outside Of Browsers
WEBOOB_RUN_DEPENDS=	${KDE_PREFIX}/lib/kde4/krosspython.so:devel/py-krosspython-kde4 \
			${PYTHON_PKGNAMEPREFIX}weboob>=0:www/py-weboob@${PY_FLAVOR}
WEBOOB_USES=		python:run
WEBOOB_CMAKE_BOOL=	ENABLE_WEBOOB

.if defined(MAINTAINER_MODE)
# Apply additional substitutions to pkg-plist generated by the 'makeplist' target
create-plist: stage
	@(cd ${.CURDIR} && ${MAKE} makeplist > pkg-plist && \
	${SED} -i "" -e '1d' \
		-e '/share\/locale/s|^|%%NLS%%|g' \
		-e 's|KDE4_KDELIBS_VERSION|KDE4_GENERIC_LIB_VERSION|g' \
		-e '/icalendar/s|^|%%CALENDAR%%|g' -e '/kbanking/s|^|%%KBANKING%%|g' \
		-e '/ofximport/s|^|%%OFX%%|g' -e '/weboob/s|^|%%WEBOOB%%|g' \
		pkg-plist)
.endif

.include <bsd.port.mk>
