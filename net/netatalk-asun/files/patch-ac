--- sys/freebsd/Makefile.orig	Thu Feb  4 16:38:12 1999
+++ sys/freebsd/Makefile	Sat Dec 23 13:25:22 2000
@@ -1,9 +1,14 @@
 # FreeBSD specific defines, passed to subdirectories.
-#DEFS= -DBSD4_4 -DSENDFILE_FLAVOR_BSD
 DEFS=	-DBSD4_4
-OPTOPTS=	-O2
+.if defined(USE_SENDFILE)
+DEFS+=	-DSENDFILE_FLAVOR_BSD
+.endif
+.if defined(USE_CNID)
+DEFS+=	-DUSE_CNID
+.endif
+#OPTOPTS=	-O2
 CC=	gcc
-INSTALL=	install
+#INSTALL=	install
 AFPLIBS=	-lcrypt -lrpcsvc
 ADDLIBS=	
 
@@ -11,9 +16,17 @@
 
 oops:
 	@echo "Read README again.  Don't type 'make' here."
-	@exit 1
+	@exit 64
 
-all:	${ALL}
+all:
+	for i in ${ALL}; \
+	  do (cd $${i}; ${MAKE} ${MFLAGS} CC="${CC}" \
+	    ADDLIBS="${ADDLIBS}" DEFS="${DEFS}" OPTOPTS="${OPTOPTS}" \
+	    SBINDIR="${SBINDIR}" BINDIR="${BINDIR}" RESDIR="${RESDIR}" \
+	    ETCDIR="${ETCDIR}" LIBDIR="${LIBDIR}" INCDIR="${INCDIR}" \
+	    DESTDIR="${DESTDIR}" AFSDIR="${AFSDIR}" KRBDIR="${KRBDIR}" \
+	    AFPLIBS="${AFPLIBS}" all); \
+	done
 
 ../../bin ../../etc:	../../libatalk
 
@@ -28,7 +41,8 @@
 FRC:
 
 install :
-	-mkdir ${DESTDIR} ${SBINDIR} ${BINDIR} ${ETCDIR} ${LIBDIR}
+	mkdir -p ${DESTDIR} ${SBINDIR} ${BINDIR} ${ETCDIR} ${LIBDIR} \
+		${RESDIR}/examples/netatalk ${ETCDIR}/rc.d
 	for i in ${ALL}; \
 	    do (cd $$i; ${MAKE} ${MFLAGS} CC="${CC}" \
 		ADDLIBS="${ADDLIBS}" DEFS="${DEFS}" OPTOPTS="${OPTOPTS}" \
@@ -37,17 +51,21 @@
 		AFSDIR="${AFSDIR}" KRBDIR="${KRBDIR}" AFPLIBS="${AFPLIBS}" \
 		INSTALL="${INSTALL}" $@); \
 	done
-	rm -f ${ETCDIR}/rc.atalk
 	sed -e s@:DESTDIR:@${DESTDIR}@ -e s@:SBINDIR:@${SBINDIR}@ \
 		-e s@:BINDIR:@${BINDIR}@ -e s@:RESDIR:@${RESDIR}@ \
 		-e s@:ETCDIR:@${ETCDIR}@ -e s@:LIBDIR:@${LIBDIR}@ \
 		-e s@:INCDIR:@${INCDIR}@ \
-	    < ../../rc.atalk.bsd > ${ETCDIR}/rc.atalk
-	@echo
-	@echo "Install is done.  Don't forget to add lines from"
-	@echo "services.atalk to /etc/services and to call rc.atalk"
-	@echo "in /etc/rc.  See README and README.FREEBSD for more"
-	@echo "information."
+	    < ../../rc.atalk.freebsd > ${ETCDIR}/rc.d/netatalk.sh
+	chmod +x ${ETCDIR}/rc.d/netatalk.sh
+	cp ../../config/AppleVolumes.default ${ETCDIR}/AppleVolumes.default.dist
+	cp ../../config/AppleVolumes.system ${ETCDIR}/AppleVolumes.system.dist
+	sed -e s@:DESTDIR:@${DESTDIR}@ -e s@:SBINDIR:@${SBINDIR}@ \
+		-e s@:BINDIR:@${BINDIR}@ -e s@:RESDIR:@${RESDIR}@ \
+		-e s@:ETCDIR:@${ETCDIR}@ -e s@:LIBDIR:@${LIBDIR}@ \
+		-e s@:INCDIR:@${INCDIR}@ \
+	    <../../config/afpd.conf >${ETCDIR}/afpd.conf.dist
+	cp ../../config/atalkd.conf ../../config/papd.conf \
+		${RESDIR}/examples/netatalk
 
 clean :
 	for i in ${ALL}; \
