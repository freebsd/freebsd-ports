#!/bin/sh

answset () {
  if [ -n "$NO_INPUT" ]; then
    echo "$2 [$1]"
    answ=$1
  else
    answ=X
  fi
}

yesno () {
  answset $1 "$2"
  while [ $answ = X ]; do
    echo -n "$2 [$1] "
    read answ
    if [ X$answ = X ]; then answ=$1; fi
    case $answ in
      y|yes|Y|YES) answ=YES;;
      n|no|N|NO)   answ=NO;;
      *) echo invalid answer
      answ=X
      ;;
    esac
  done
}
# workaround for compilation problems if XFree-4.0.x is installed
if [ -e ${PREFIX}/lib/libXft.so.1 ]; then
  r=`nm  ${PREFIX}/lib/libXft.so.1 | grep XftDirSave`
  if [ "X$r" = X ]; then 
    echo "you seem to have an installed XFree-4.0.x port"
    echo "please rename or remove ${PREFIX}/lib/libXft.so.1"
    echo "in order to avoid compilation problems"
    exit 1
  fi
fi
F=$WRKDIR/.config
configure () {
rm -f $F

# set ProjectRoot to be ${PREFIX}
echo "#define ProjectRoot ${PREFIX}" >>$F

cat >> $F <<END
#ifdef i386Architecture
#define XF86CardDrivers         mga glint nv tga s3 s3virge sis rendition \
                                neomagic i740 tdfx savage \
                                cirrus vmware tseng trident chips apm \
                                GlideDriver fbdev i128 \
                                ati AgpGartDrivers ark cyrix \
                                siliconmotion \
                                vesa vga XF86OSCardDrivers XF86ExtraCardDrivers
#else
#define XF86CardDrivers         mga glint nv tga s3 s3virge sis rendition \
                                neomagic i740 tdfx savage \
                                cirrus tseng trident chips apm \
                                GlideDriver fbdev i128 \
                                ati DevelDrivers ark cyrix \
                                siliconmotion \
                                vesa vga XF86OSCardDrivers XF86ExtraCardDrivers
#endif
END

cat <<EOF
app-default files, startup configuration files, keyboard definitions
are normally installed in /etc/X11 (so that X binaries can be mounted 
from a read-only volume like a CD-ROM). Otherwise default files will 
be installed under /usr/X11R6.
EOF
yesno YES "Install config files in /etc/X11?"
if [ $answ = NO ]; then
    echo '#define UseSeparateConfDir NO' >> $F
    ETC=${PREFIX}/lib
else
    ETC=/etc
fi

cat <<END
 Do you want to install the default system config files? This will overwrite
 and files that you may be currently using.  This would only be required
 on a first time build.
END
if [ -e $ETC/X11/xdm/xdm-config ]; then
    XDMDEFAULT=NO
else
    XDMDEFAULT=YES
fi
if [ -e $ETC/X11/xinit/xinitrc ]; then
    XINITDEFAULT=NO
else
    XINITDEFAULT=YES
fi
if [ -e ${PREFIX}/lib/X11/fs/config ]; then
    XFSDEFAULT=NO
else
    XFSDEFAULT=YES
fi

yesno $XDMDEFAULT "Install xdm config?"
echo "#define InstallXdmConfig	$answ" >> $F
yesno $XINITDEFAULT "Install xinit config?"
echo "#define InstallXinitConfig $answ" >> $F

yesno YES "Do you want to include support for the FontServer?"
echo "#define  BuildFontServer $answ" >>$F
if [ $answ = YES ]; then
    yesno $XFSDEFAULT "Install xfs config?"
    echo "#define InstallFSConfig $answ" >> $F
else
    echo "#define InstallFSConfig NO" >> $F
fi

yesno YES "Do you want support for TrueType fonts?"
if [ $answ = NO ]; then
    echo "#define BuildFreeType           NO" >> $F
    echo "#define BuildXTrueType          NO" >> $F
fi
cat <<'END'
 Do you want to Build Fonts (Usually you only want to build and install
 fonts once, if this is a first time install you will want to build the
 fonts)
END
yesno YES "Build fonts?"
echo "#define BuildFonts		$answ" >> $F
if [ $answ = YES ]; then
  yesno YES "Build/install the 75dpi fonts?"
  echo "#define Build75DpiFonts	$answ" >> $F
  yesno YES "Build/install the 100dpi fonts?"
  echo "#define Build100DpiFonts	$answ" >> $F
  yesno YES "Build/install the Speedo fonts?"
  echo "#define BuildSpeedoFonts	$answ" >> $F
  yesno YES "Build/install the Type1 fonts?"
  echo "#define BuildType1Fonts	$answ" >> $F
  yesno YES "Build/install the CID fonts?"
  echo "#define BuildCIDFonts	$answ" >> $F
  yesno YES "Build/install the Cyrillic fonts?"
  echo "#define BuildCyrillicFonts	$answ" >> $F
  yesno YES "Build/install the Latin2 fonts?"
  echo "#define BuildLatin2Fonts	$answ" >> $F
fi

yesno YES "Build the servers with Extended input devices?"
if [ $answ = NO ]; then
  echo "#define XInputDrivers mouse"  >> $F
else
  echo "#define XInputDrivers mouse dynapro elo2300 elographics magellan microtouch \
        mutouch spaceorb wacom void"  >> $F
# XXX broken in 3.9.18
#  if [ X${MACHINE} != X"alpha" ]; then
#    echo "#define JoystickSupport		YES" >> $F
#  fi
fi

yesno YES "Build PEX?"
echo "#define BuildPexExt		$answ" >> $F

yesno YES "Build Xinerama?"
echo "#define BuildXinerama  $answ" >> $F

yesno YES "Build XIE?"
echo "#define BuildXIE		$answ" >> $F
echo

# XXX We may not want to default this to 'YES' if there are any app-default
# files installed
yesno YES "Install application defaults files?"
echo "#define InstallAppDefFiles      $answ" >> $F

yesno YES "Build static libraries in addition to shared libraries?"
echo "#define ForceNormalLib		$answ" >> $F

if [ ${OSVERSION} -ge 300000 ]; then
cat <<'END'

 FreeBSD-3.x has support for Secure RPC.

 While this scheme is not used for general purpose encryption, 
 some countries restrict the use of strong cryptography.

END
yesno YES "Build with Secure RPC?"
echo "#define HasSecureRPC		$answ" >> $F
fi
cat <<'END'

 MIT supplies an authentication mechanism that relies upon DES, this is
 called XDM-AUTHORIZATION-1.

 Source code for this authentication mechanism may not be exported from
 the United States, however, there are compatible replacements for this
 mechanism available elsewhere.  Also, while this scheme is not used for
 general purpose encryption,  some countries restrict the use of strong
 cryptography.

 If you have aquired a copy of "Wraphelp.c" and it currently resides in
 the same location as the XFree86 source or in the ports "files"
 subdirectory,  it will be copied into the right place in the X11 source
 distribution and support for this feature will be enabled if you answer
 YES to the following question.

 If you do not have a copy of this file, even if you answer YES to this
 question, support will not be enabled.  If you wish to change this later,
 the option controling this is contained the file xc/config/cf/xf86site.def.

END
yesno YES "Do you want to enable XDM-AUTHORIZATION-1 support?"
cpwh=NO
if [ $answ = YES ]; then
    WH=$WRKDIR/xc/lib/Xdmcp/Wraphelp.c

    if [ -f $WH ] ; then
	echo "==> $WH found in source distribution."
    elif [ -f $DISTDIR/xc/Wraphelp.c ] ; then
	echo "==> Wraphelp.c found in DISTDIR directory, copying to source tree."
	cpwh=$DISTDIR/xc/Wraphelp.c
    elif [ -f $FILESDIR/Wraphelp.c ] ; then
	echo "==> Wraphelp.c found in files directory, copying to source tree."
	cpwh=$FILESDIR/Wraphelp.c
    else
      echo "==> Wraphelp.c not found, DES support NOT enabled."
      cpwh=NO
    fi
fi
if [ $cpwh != NO ]; then
  echo "#define	HasXdmAuth		$answ"	>> $F
fi

echo
yesno YES "Do you want to compile with PAM support?"
echo "#define	HasPam			$answ"	>> $F

echo "#define InstallXserverSetUID NO "	>> $F
echo "#define BuildXF86DRI YES" 	>> $F
}

configure

if [ X$cpwh != XNO ]; then
  tr -d '\r' < $cpwh > $WH
fi

cat $F >>  $WRKDIR/xc/config/cf/xf86site.def

if [ X${MACHINE} = X"alpha" ]; then
    cat $PKGDIR/pkg-plist | sed -e /MATROX_GXX/d \
	                        -e '/bin\/scanpci/d' \
	                        -e /i810/d \
	                        -e /vmware/d \
	                        -e /savage/d \
	                        -e '/fonts\/PEX\/Roman/d' \
                                -e /libafb/d  > $WRKDIR/pkg-plist
elif [ X${MACHINE} = X"pc98" ]; then
    cat $PKGDIR/pkg-plist | sed -e /MATROX_GXX/d > $WRKDIR/pkg-plist
else
    cp $PKGDIR/pkg-plist $WRKDIR/pkg-plist
fi
exit 0
