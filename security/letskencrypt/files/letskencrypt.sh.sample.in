#!/bin/sh -e

BASEDIR="%%PREFIX%%/etc/letsencrypt"
SSLDIR="%%PREFIX%%/etc/ssl/letsencrypt"
DOMAINSFILE="${BASEDIR}/domains.txt"
CHALLENGEDIR="/usr/jails/http/usr/local/www/.well-known/acme-challenge"

[ ! -d "${SSLDIR}/priv" ] && mkdir -pm700 "${SSLDIR}/private"

cat "${DOMAINSFILE}" | while read domain line ; do
   CERTSDIR="${SSLDIR}/${domain}"
   [ ! -d "${CERTSDIR}" ] && mkdir -pm755 "${CERTSDIR}"
   set +e # RC=2 when time to expire > 30 days
   letskencrypt -C "${CHALLENGEDIR}" \
                -k "${SSLDIR}/private/${domain}.pem" \
                -c "${CERTSDIR}" \
                ${domain} ${line}
   RC=$?
   set -e
   [ $RC -ne 0 -a $RC -ne 2 ] && exit $RC
done
