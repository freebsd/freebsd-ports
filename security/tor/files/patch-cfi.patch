diff -ur ../tor-0.3.0.10.orig/Makefile.in ./Makefile.in
--- ../tor-0.3.0.10.orig/Makefile.in	2017-08-01 14:39:18.000000000 -0400
+++ ./Makefile.in	2017-08-29 17:00:03.000000000 -0400
@@ -1,7 +1,7 @@
-# Makefile.in generated by automake 1.15 from Makefile.am.
+# Makefile.in generated by automake 1.15.1 from Makefile.am.
 # @configure_input@
 
-# Copyright (C) 1994-2014 Free Software Foundation, Inc.
+# Copyright (C) 1994-2017 Free Software Foundation, Inc.
 
 # This Makefile.in is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -142,8 +142,9 @@
 @UNITTESTS_ENABLED_TRUE@	src/or/libtor-testing.a
 
 @COVERAGE_ENABLED_TRUE@am__append_8 = src/or/tor-cov
-@USEPYTHON_TRUE@am__append_9 = src/test/test_ntor.sh src/test/test_bt.sh
-@UNITTESTS_ENABLED_TRUE@am__append_10 = \
+@CFI_ENABLED_TRUE@am__append_9 = -flto -fvisibility=hidden -fsanitize=cfi
+@USEPYTHON_TRUE@am__append_10 = src/test/test_ntor.sh src/test/test_bt.sh
+@UNITTESTS_ENABLED_TRUE@am__append_11 = \
 @UNITTESTS_ENABLED_TRUE@	src/test/test \
 @UNITTESTS_ENABLED_TRUE@	src/test/test-slow \
 @UNITTESTS_ENABLED_TRUE@	src/test/test-memwipe \
@@ -152,8 +153,8 @@
 @UNITTESTS_ENABLED_TRUE@	src/test/test-switch-id \
 @UNITTESTS_ENABLED_TRUE@	src/test/test-timers
 
-@COVERAGE_ENABLED_TRUE@am__append_11 = src/tools/tor-cov-resolve src/tools/tor-cov-gencert
-@LIBFUZZER_ENABLED_TRUE@am__append_12 = -fsanitize-coverage=trace-pc-guard,trace-cmp,trace-div
+@COVERAGE_ENABLED_TRUE@am__append_12 = src/tools/tor-cov-resolve src/tools/tor-cov-gencert
+@LIBFUZZER_ENABLED_TRUE@am__append_13 = -fsanitize-coverage=trace-pc-guard,trace-cmp,trace-div
 subdir = .
 ACLOCAL_M4 = $(top_srcdir)/aclocal.m4
 am__aclocal_m4_deps = $(top_srcdir)/m4/ax_check_sign.m4 \
@@ -688,14 +689,14 @@
 @LIBFUZZER_ENABLED_TRUE@	src/test/fuzz/lf-fuzz-microdesc$(EXEEXT) \
 @LIBFUZZER_ENABLED_TRUE@	src/test/fuzz/lf-fuzz-vrs$(EXEEXT)
 PROGRAMS = $(bin_PROGRAMS) $(noinst_PROGRAMS)
-am_src_or_tor_OBJECTS = src/or/tor_main.$(OBJEXT)
+am_src_or_tor_OBJECTS = src/or/src_or_tor-tor_main.$(OBJEXT)
 src_or_tor_OBJECTS = $(am_src_or_tor_OBJECTS)
 src_or_tor_DEPENDENCIES = src/or/libtor.a src/common/libor.a \
 	src/common/libor-ctime.a src/common/libor-crypto.a \
 	$(LIBKECCAK_TINY) $(LIBDONNA) src/common/libor-event.a \
 	src/trunnel/libor-trunnel.a
-src_or_tor_LINK = $(CCLD) $(AM_CFLAGS) $(CFLAGS) $(src_or_tor_LDFLAGS) \
-	$(LDFLAGS) -o $@
+src_or_tor_LINK = $(CCLD) $(src_or_tor_CFLAGS) $(CFLAGS) \
+	$(src_or_tor_LDFLAGS) $(LDFLAGS) -o $@
 am__src_or_tor_cov_SOURCES_DIST = src/or/tor_main.c
 @COVERAGE_ENABLED_TRUE@am_src_or_tor_cov_OBJECTS = src/or/src_or_tor_cov-tor_main.$(OBJEXT)
 src_or_tor_cov_OBJECTS = $(am_src_or_tor_cov_OBJECTS)
@@ -2070,7 +2071,8 @@
 # -L flags need to go in LDFLAGS. -l flags need to go in LDADD.
 # This seems to matter nowhere but on windows, but I assure you that it
 # matters a lot there, and is quite hard to debug if you forget to do it.
-src_or_tor_LDFLAGS = @TOR_LDFLAGS_zlib@ @TOR_LDFLAGS_openssl@ @TOR_LDFLAGS_libevent@
+src_or_tor_LDFLAGS = @TOR_LDFLAGS_zlib@ @TOR_LDFLAGS_openssl@ \
+	@TOR_LDFLAGS_libevent@ $(am__append_9)
 src_or_tor_LDADD = src/or/libtor.a src/common/libor.a src/common/libor-ctime.a \
 	src/common/libor-crypto.a $(LIBKECCAK_TINY) $(LIBDONNA) \
 	src/common/libor-event.a src/trunnel/libor-trunnel.a \
@@ -2088,6 +2090,7 @@
 @COVERAGE_ENABLED_TRUE@	@TOR_ZLIB_LIBS@ @TOR_LIB_MATH@ @TOR_LIBEVENT_LIBS@ @TOR_OPENSSL_LIBS@ \
 @COVERAGE_ENABLED_TRUE@	@TOR_LIB_WS32@ @TOR_LIB_GDI@ @CURVE25519_LIBS@ @TOR_SYSTEMD_LIBS@
 
+@CFI_ENABLED_TRUE@src_or_tor_CFLAGS = -flto -fvisibility=hidden -fsanitize=cfi
 ORHEADERS = \
 	src/or/addressmap.h				\
 	src/or/bridges.h				\
@@ -2184,7 +2187,7 @@
 	src/test/test_workqueue_pipe.sh \
 	src/test/test_workqueue_pipe2.sh \
 	src/test/test_workqueue_socketpair.sh \
-	src/test/test_switch_id.sh $(am__append_9)
+	src/test/test_switch_id.sh $(am__append_10)
 
 # These flavors are run using automake's test-driver and test-network.sh
 TEST_CHUTNEY_FLAVORS = basic-min bridges-min hs-min single-onion
@@ -2675,9 +2678,9 @@
 @USE_ASCIIDOC_TRUE@txt_in = $(all_mans:=.1.txt)
 asciidoc_product = $(nodist_man1_MANS) $(doc_DATA)
 AM_ETAGSFLAGS = --regex='{c}/MOCK_IMPL([^,]+,\W*\([a-zA-Z0-9_]+\)\W*,/\1/s'
-@COVERAGE_ENABLED_FALSE@TEST_CFLAGS = $(am__append_12)
+@COVERAGE_ENABLED_FALSE@TEST_CFLAGS = $(am__append_13)
 @COVERAGE_ENABLED_TRUE@TEST_CFLAGS = -fno-inline -fprofile-arcs \
-@COVERAGE_ENABLED_TRUE@	-ftest-coverage $(am__append_12)
+@COVERAGE_ENABLED_TRUE@	-ftest-coverage $(am__append_13)
 @COVERAGE_ENABLED_FALSE@TEST_CPPFLAGS = -DTOR_UNIT_TESTS
 @COVERAGE_ENABLED_TRUE@@DISABLE_ASSERTS_IN_UNIT_TESTS_FALSE@TEST_CPPFLAGS = -DTOR_UNIT_TESTS -DTOR_COVERAGE
 @COVERAGE_ENABLED_TRUE@@DISABLE_ASSERTS_IN_UNIT_TESTS_TRUE@TEST_CPPFLAGS = -DTOR_UNIT_TESTS -DTOR_COVERAGE -DDISABLE_ASSERTS_IN_UNIT_TESTS
@@ -3695,7 +3698,7 @@
 
 clean-noinstPROGRAMS:
 	-test -z "$(noinst_PROGRAMS)" || rm -f $(noinst_PROGRAMS)
-src/or/tor_main.$(OBJEXT): src/or/$(am__dirstamp) \
+src/or/src_or_tor-tor_main.$(OBJEXT): src/or/$(am__dirstamp) \
 	src/or/$(DEPDIR)/$(am__dirstamp)
 
 src/or/tor$(EXEEXT): $(src_or_tor_OBJECTS) $(src_or_tor_DEPENDENCIES) $(EXTRA_src_or_tor_DEPENDENCIES) src/or/$(am__dirstamp)
@@ -4435,10 +4438,10 @@
 @AMDEP_TRUE@@am__include@ @am__quote@src/or/$(DEPDIR)/src_or_libtor_testing_a-status.Po@am__quote@
 @AMDEP_TRUE@@am__include@ @am__quote@src/or/$(DEPDIR)/src_or_libtor_testing_a-torcert.Po@am__quote@
 @AMDEP_TRUE@@am__include@ @am__quote@src/or/$(DEPDIR)/src_or_libtor_testing_a-transports.Po@am__quote@
+@AMDEP_TRUE@@am__include@ @am__quote@src/or/$(DEPDIR)/src_or_tor-tor_main.Po@am__quote@
 @AMDEP_TRUE@@am__include@ @am__quote@src/or/$(DEPDIR)/src_or_tor_cov-tor_main.Po@am__quote@
 @AMDEP_TRUE@@am__include@ @am__quote@src/or/$(DEPDIR)/statefile.Po@am__quote@
 @AMDEP_TRUE@@am__include@ @am__quote@src/or/$(DEPDIR)/status.Po@am__quote@
-@AMDEP_TRUE@@am__include@ @am__quote@src/or/$(DEPDIR)/tor_main.Po@am__quote@
 @AMDEP_TRUE@@am__include@ @am__quote@src/or/$(DEPDIR)/torcert.Po@am__quote@
 @AMDEP_TRUE@@am__include@ @am__quote@src/or/$(DEPDIR)/transports.Po@am__quote@
 @AMDEP_TRUE@@am__include@ @am__quote@src/test/$(DEPDIR)/bench.Po@am__quote@
@@ -7195,6 +7198,20 @@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='src/trunnel/hs/cell_introduce1.c' object='src/trunnel/hs/src_trunnel_libor_trunnel_a-cell_introduce1.obj' libtool=no @AMDEPBACKSLASH@
 @AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
 @am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(src_trunnel_libor_trunnel_a_CPPFLAGS) $(CPPFLAGS) $(AM_CFLAGS) $(CFLAGS) -c -o src/trunnel/hs/src_trunnel_libor_trunnel_a-cell_introduce1.obj `if test -f 'src/trunnel/hs/cell_introduce1.c'; then $(CYGPATH_W) 'src/trunnel/hs/cell_introduce1.c'; else $(CYGPATH_W) '$(srcdir)/src/trunnel/hs/cell_introduce1.c'; fi`
+
+src/or/src_or_tor-tor_main.o: src/or/tor_main.c
+@am__fastdepCC_TRUE@	$(AM_V_CC)$(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(src_or_tor_CFLAGS) $(CFLAGS) -MT src/or/src_or_tor-tor_main.o -MD -MP -MF src/or/$(DEPDIR)/src_or_tor-tor_main.Tpo -c -o src/or/src_or_tor-tor_main.o `test -f 'src/or/tor_main.c' || echo '$(srcdir)/'`src/or/tor_main.c
+@am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) src/or/$(DEPDIR)/src_or_tor-tor_main.Tpo src/or/$(DEPDIR)/src_or_tor-tor_main.Po
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='src/or/tor_main.c' object='src/or/src_or_tor-tor_main.o' libtool=no @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(src_or_tor_CFLAGS) $(CFLAGS) -c -o src/or/src_or_tor-tor_main.o `test -f 'src/or/tor_main.c' || echo '$(srcdir)/'`src/or/tor_main.c
+
+src/or/src_or_tor-tor_main.obj: src/or/tor_main.c
+@am__fastdepCC_TRUE@	$(AM_V_CC)$(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(src_or_tor_CFLAGS) $(CFLAGS) -MT src/or/src_or_tor-tor_main.obj -MD -MP -MF src/or/$(DEPDIR)/src_or_tor-tor_main.Tpo -c -o src/or/src_or_tor-tor_main.obj `if test -f 'src/or/tor_main.c'; then $(CYGPATH_W) 'src/or/tor_main.c'; else $(CYGPATH_W) '$(srcdir)/src/or/tor_main.c'; fi`
+@am__fastdepCC_TRUE@	$(AM_V_at)$(am__mv) src/or/$(DEPDIR)/src_or_tor-tor_main.Tpo src/or/$(DEPDIR)/src_or_tor-tor_main.Po
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	$(AM_V_CC)source='src/or/tor_main.c' object='src/or/src_or_tor-tor_main.obj' libtool=no @AMDEPBACKSLASH@
+@AMDEP_TRUE@@am__fastdepCC_FALSE@	DEPDIR=$(DEPDIR) $(CCDEPMODE) $(depcomp) @AMDEPBACKSLASH@
+@am__fastdepCC_FALSE@	$(AM_V_CC@am__nodep@)$(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(AM_CPPFLAGS) $(CPPFLAGS) $(src_or_tor_CFLAGS) $(CFLAGS) -c -o src/or/src_or_tor-tor_main.obj `if test -f 'src/or/tor_main.c'; then $(CYGPATH_W) 'src/or/tor_main.c'; else $(CYGPATH_W) '$(srcdir)/src/or/tor_main.c'; fi`
 
 src/or/src_or_tor_cov-tor_main.o: src/or/tor_main.c
 @am__fastdepCC_TRUE@	$(AM_V_CC)$(CC) $(DEFS) $(DEFAULT_INCLUDES) $(INCLUDES) $(src_or_tor_cov_CPPFLAGS) $(CPPFLAGS) $(src_or_tor_cov_CFLAGS) $(CFLAGS) -MT src/or/src_or_tor_cov-tor_main.o -MD -MP -MF src/or/$(DEPDIR)/src_or_tor_cov-tor_main.Tpo -c -o src/or/src_or_tor_cov-tor_main.o `test -f 'src/or/tor_main.c' || echo '$(srcdir)/'`src/or/tor_main.c
diff -ur ../tor-0.3.0.10.orig/aclocal.m4 ./aclocal.m4
--- ../tor-0.3.0.10.orig/aclocal.m4	2017-08-01 14:39:16.000000000 -0400
+++ ./aclocal.m4	2017-08-29 16:59:59.000000000 -0400
@@ -1,6 +1,6 @@
-# generated automatically by aclocal 1.15 -*- Autoconf -*-
+# generated automatically by aclocal 1.15.1 -*- Autoconf -*-
 
-# Copyright (C) 1996-2014 Free Software Foundation, Inc.
+# Copyright (C) 1996-2017 Free Software Foundation, Inc.
 
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -20,7 +20,7 @@
 If you have problems, you may need to regenerate the build system entirely.
 To do so, use the procedure documented by the package, typically 'autoreconf'.])])
 
-# Copyright (C) 2002-2014 Free Software Foundation, Inc.
+# Copyright (C) 2002-2017 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -35,7 +35,7 @@
 [am__api_version='1.15'
 dnl Some users find AM_AUTOMAKE_VERSION and mistake it for a way to
 dnl require some minimum version.  Point them to the right macro.
-m4_if([$1], [1.15], [],
+m4_if([$1], [1.15.1], [],
       [AC_FATAL([Do not call $0, use AM_INIT_AUTOMAKE([$1]).])])dnl
 ])
 
@@ -51,12 +51,12 @@
 # Call AM_AUTOMAKE_VERSION and AM_AUTOMAKE_VERSION so they can be traced.
 # This function is AC_REQUIREd by AM_INIT_AUTOMAKE.
 AC_DEFUN([AM_SET_CURRENT_AUTOMAKE_VERSION],
-[AM_AUTOMAKE_VERSION([1.15])dnl
+[AM_AUTOMAKE_VERSION([1.15.1])dnl
 m4_ifndef([AC_AUTOCONF_VERSION],
   [m4_copy([m4_PACKAGE_VERSION], [AC_AUTOCONF_VERSION])])dnl
 _AM_AUTOCONF_VERSION(m4_defn([AC_AUTOCONF_VERSION]))])
 
-# Copyright (C) 2011-2014 Free Software Foundation, Inc.
+# Copyright (C) 2011-2017 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -118,7 +118,7 @@
 
 # AM_AUX_DIR_EXPAND                                         -*- Autoconf -*-
 
-# Copyright (C) 2001-2014 Free Software Foundation, Inc.
+# Copyright (C) 2001-2017 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -170,7 +170,7 @@
 
 # AM_CONDITIONAL                                            -*- Autoconf -*-
 
-# Copyright (C) 1997-2014 Free Software Foundation, Inc.
+# Copyright (C) 1997-2017 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -201,7 +201,7 @@
 Usually this means the macro was only invoked conditionally.]])
 fi])])
 
-# Copyright (C) 1999-2014 Free Software Foundation, Inc.
+# Copyright (C) 1999-2017 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -392,7 +392,7 @@
 
 # Generate code to set up dependency tracking.              -*- Autoconf -*-
 
-# Copyright (C) 1999-2014 Free Software Foundation, Inc.
+# Copyright (C) 1999-2017 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -468,7 +468,7 @@
 
 # Do all the work for Automake.                             -*- Autoconf -*-
 
-# Copyright (C) 1996-2014 Free Software Foundation, Inc.
+# Copyright (C) 1996-2017 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -665,7 +665,7 @@
 done
 echo "timestamp for $_am_arg" >`AS_DIRNAME(["$_am_arg"])`/stamp-h[]$_am_stamp_count])
 
-# Copyright (C) 2001-2014 Free Software Foundation, Inc.
+# Copyright (C) 2001-2017 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -686,7 +686,7 @@
 fi
 AC_SUBST([install_sh])])
 
-# Copyright (C) 2003-2014 Free Software Foundation, Inc.
+# Copyright (C) 2003-2017 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -707,7 +707,7 @@
 
 # Check to see how 'make' treats includes.	            -*- Autoconf -*-
 
-# Copyright (C) 2001-2014 Free Software Foundation, Inc.
+# Copyright (C) 2001-2017 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -757,7 +757,7 @@
 
 # Fake the existence of programs that GNU maintainers use.  -*- Autoconf -*-
 
-# Copyright (C) 1997-2014 Free Software Foundation, Inc.
+# Copyright (C) 1997-2017 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -796,7 +796,7 @@
 
 # Helper functions for option handling.                     -*- Autoconf -*-
 
-# Copyright (C) 2001-2014 Free Software Foundation, Inc.
+# Copyright (C) 2001-2017 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -825,7 +825,7 @@
 AC_DEFUN([_AM_IF_OPTION],
 [m4_ifset(_AM_MANGLE_OPTION([$1]), [$2], [$3])])
 
-# Copyright (C) 1999-2014 Free Software Foundation, Inc.
+# Copyright (C) 1999-2017 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -872,7 +872,7 @@
 # For backward compatibility.
 AC_DEFUN_ONCE([AM_PROG_CC_C_O], [AC_REQUIRE([AC_PROG_CC])])
 
-# Copyright (C) 2001-2014 Free Software Foundation, Inc.
+# Copyright (C) 2001-2017 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -891,7 +891,7 @@
 
 # Check to make sure that the build environment is sane.    -*- Autoconf -*-
 
-# Copyright (C) 1996-2014 Free Software Foundation, Inc.
+# Copyright (C) 1996-2017 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -972,7 +972,7 @@
 rm -f conftest.file
 ])
 
-# Copyright (C) 2009-2014 Free Software Foundation, Inc.
+# Copyright (C) 2009-2017 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -1032,7 +1032,7 @@
 _AM_SUBST_NOTMAKE([AM_BACKSLASH])dnl
 ])
 
-# Copyright (C) 2001-2014 Free Software Foundation, Inc.
+# Copyright (C) 2001-2017 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -1060,7 +1060,7 @@
 INSTALL_STRIP_PROGRAM="\$(install_sh) -c -s"
 AC_SUBST([INSTALL_STRIP_PROGRAM])])
 
-# Copyright (C) 2006-2014 Free Software Foundation, Inc.
+# Copyright (C) 2006-2017 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
@@ -1079,7 +1079,7 @@
 
 # Check how to create a tarball.                            -*- Autoconf -*-
 
-# Copyright (C) 2004-2014 Free Software Foundation, Inc.
+# Copyright (C) 2004-2017 Free Software Foundation, Inc.
 #
 # This file is free software; the Free Software Foundation
 # gives unlimited permission to copy and/or distribute it,
diff -ur ../tor-0.3.0.10.orig/ar-lib ./ar-lib
--- ../tor-0.3.0.10.orig/ar-lib	2017-06-08 09:36:35.000000000 -0400
+++ ./ar-lib	2017-08-29 17:00:02.000000000 -0400
@@ -4,7 +4,7 @@
 me=ar-lib
 scriptversion=2012-03-01.08; # UTC
 
-# Copyright (C) 2010-2014 Free Software Foundation, Inc.
+# Copyright (C) 2010-2017 Free Software Foundation, Inc.
 # Written by Peter Rosin <peda@lysator.liu.se>.
 #
 # This program is free software; you can redistribute it and/or modify
Only in .: autom4te.cache
diff -ur ../tor-0.3.0.10.orig/compile ./compile
--- ../tor-0.3.0.10.orig/compile	2017-06-08 09:36:35.000000000 -0400
+++ ./compile	2017-08-29 17:00:02.000000000 -0400
@@ -1,9 +1,9 @@
 #! /bin/sh
 # Wrapper for compilers which do not understand '-c -o'.
 
-scriptversion=2012-10-14.11; # UTC
+scriptversion=2016-01-11.22; # UTC
 
-# Copyright (C) 1999-2014 Free Software Foundation, Inc.
+# Copyright (C) 1999-2017 Free Software Foundation, Inc.
 # Written by Tom Tromey <tromey@cygnus.com>.
 #
 # This program is free software; you can redistribute it and/or modify
@@ -255,7 +255,8 @@
     echo "compile $scriptversion"
     exit $?
     ;;
-  cl | *[/\\]cl | cl.exe | *[/\\]cl.exe )
+  cl | *[/\\]cl | cl.exe | *[/\\]cl.exe | \
+  icl | *[/\\]icl | icl.exe | *[/\\]icl.exe )
     func_cl_wrapper "$@"      # Doesn't return...
     ;;
 esac
@@ -342,6 +343,6 @@
 # eval: (add-hook 'write-file-hooks 'time-stamp)
 # time-stamp-start: "scriptversion="
 # time-stamp-format: "%:y-%02m-%02d.%02H"
-# time-stamp-time-zone: "UTC"
+# time-stamp-time-zone: "UTC0"
 # time-stamp-end: "; # UTC"
 # End:
diff -ur ../tor-0.3.0.10.orig/config.guess ./config.guess
--- ../tor-0.3.0.10.orig/config.guess	2017-06-08 09:36:35.000000000 -0400
+++ ./config.guess	2017-08-29 17:00:02.000000000 -0400
@@ -2,7 +2,7 @@
 # Attempt to guess a canonical system name.
 #   Copyright 1992-2015 Free Software Foundation, Inc.
 
-timestamp='2015-01-01'
+timestamp='2015-03-04'
 
 # This file is free software; you can redistribute it and/or modify it
 # under the terms of the GNU General Public License as published by
@@ -168,20 +168,27 @@
 	# Note: NetBSD doesn't particularly care about the vendor
 	# portion of the name.  We always set it to "unknown".
 	sysctl="sysctl -n hw.machine_arch"
-	UNAME_MACHINE_ARCH=`(/sbin/$sysctl 2>/dev/null || \
-	    /usr/sbin/$sysctl 2>/dev/null || echo unknown)`
+	UNAME_MACHINE_ARCH=`(uname -p 2>/dev/null || \
+	    /sbin/$sysctl 2>/dev/null || \
+	    /usr/sbin/$sysctl 2>/dev/null || \
+	    echo unknown)`
 	case "${UNAME_MACHINE_ARCH}" in
 	    armeb) machine=armeb-unknown ;;
 	    arm*) machine=arm-unknown ;;
 	    sh3el) machine=shl-unknown ;;
 	    sh3eb) machine=sh-unknown ;;
 	    sh5el) machine=sh5le-unknown ;;
+	    earmv*)
+		arch=`echo ${UNAME_MACHINE_ARCH} | sed -e 's,^e\(armv[0-9]\).*$,\1,'`
+		endian=`echo ${UNAME_MACHINE_ARCH} | sed -ne 's,^.*\(eb\)$,\1,p'`
+		machine=${arch}${endian}-unknown
+		;;
 	    *) machine=${UNAME_MACHINE_ARCH}-unknown ;;
 	esac
 	# The Operating System including object format, if it has switched
 	# to ELF recently, or will in the future.
 	case "${UNAME_MACHINE_ARCH}" in
-	    arm*|i386|m68k|ns32k|sh3*|sparc|vax)
+	    arm*|earm*|i386|m68k|ns32k|sh3*|sparc|vax)
 		eval $set_cc_for_build
 		if echo __ELF__ | $CC_FOR_BUILD -E - 2>/dev/null \
 			| grep -q __ELF__
@@ -197,6 +204,13 @@
 		os=netbsd
 		;;
 	esac
+	# Determine ABI tags.
+	case "${UNAME_MACHINE_ARCH}" in
+	    earm*)
+		expr='s/^earmv[0-9]/-eabi/;s/eb$//'
+		abi=`echo ${UNAME_MACHINE_ARCH} | sed -e "$expr"`
+		;;
+	esac
 	# The OS release
 	# Debian GNU/NetBSD machines have a different userland, and
 	# thus, need a distinct triplet. However, they do not need
@@ -213,7 +227,7 @@
 	# Since CPU_TYPE-MANUFACTURER-KERNEL-OPERATING_SYSTEM:
 	# contains redundant information, the shorter form:
 	# CPU_TYPE-MANUFACTURER-OPERATING_SYSTEM is used.
-	echo "${machine}-${os}${release}"
+	echo "${machine}-${os}${release}${abi}"
 	exit ;;
     *:Bitrig:*:*)
 	UNAME_MACHINE_ARCH=`arch | sed 's/Bitrig.//'`
@@ -811,12 +825,7 @@
 	exit ;;
     *:FreeBSD:*:*)
 	UNAME_PROCESSOR=`/usr/bin/uname -p`
-	case ${UNAME_PROCESSOR} in
-	    amd64)
-		echo x86_64-unknown-freebsd`echo ${UNAME_RELEASE}|sed -e 's/[-(].*//'` ;;
-	    *)
-		echo ${UNAME_PROCESSOR}-unknown-freebsd`echo ${UNAME_RELEASE}|sed -e 's/[-(].*//'` ;;
-	esac
+	echo ${UNAME_PROCESSOR}-unknown-freebsd`echo ${UNAME_RELEASE}|sed -e 's/[-(].*//'`
 	exit ;;
     i*:CYGWIN*:*)
 	echo ${UNAME_MACHINE}-pc-cygwin
@@ -932,6 +941,9 @@
 	exit ;;
     crisv32:Linux:*:*)
 	echo ${UNAME_MACHINE}-axis-linux-${LIBC}
+	exit ;;
+    e2k:Linux:*:*)
+	echo ${UNAME_MACHINE}-unknown-linux-${LIBC}
 	exit ;;
     frv:Linux:*:*)
 	echo ${UNAME_MACHINE}-unknown-linux-${LIBC}
diff -ur ../tor-0.3.0.10.orig/config.sub ./config.sub
--- ../tor-0.3.0.10.orig/config.sub	2017-06-08 09:36:35.000000000 -0400
+++ ./config.sub	2017-08-29 17:00:02.000000000 -0400
@@ -2,7 +2,7 @@
 # Configuration validation subroutine script.
 #   Copyright 1992-2015 Free Software Foundation, Inc.
 
-timestamp='2015-01-01'
+timestamp='2015-03-08'
 
 # This file is free software; you can redistribute it and/or modify it
 # under the terms of the GNU General Public License as published by
@@ -117,7 +117,7 @@
 case $maybe_os in
   nto-qnx* | linux-gnu* | linux-android* | linux-dietlibc | linux-newlib* | \
   linux-musl* | linux-uclibc* | uclinux-uclibc* | uclinux-gnu* | kfreebsd*-gnu* | \
-  knetbsd*-gnu* | netbsd*-gnu* | \
+  knetbsd*-gnu* | netbsd*-gnu* | netbsd*-eabi* | \
   kopensolaris*-gnu* | \
   storm-chaos* | os2-emx* | rtmk-nova*)
     os=-$maybe_os
@@ -259,7 +259,7 @@
 	| bfin \
 	| c4x | c8051 | clipper \
 	| d10v | d30v | dlx | dsp16xx \
-	| epiphany \
+	| e2k | epiphany \
 	| fido | fr30 | frv | ft32 \
 	| h8300 | h8500 | hppa | hppa1.[01] | hppa2.0 | hppa2.0[nw] | hppa64 \
 	| hexagon \
@@ -300,7 +300,7 @@
 	| ns16k | ns32k \
 	| open8 | or1k | or1knd | or32 \
 	| pdp10 | pdp11 | pj | pjl \
-	| powerpc | powerpc64 | powerpc64le | powerpcle \
+	| powerpc | powerpc64 | powerpc64le | powerpcle | powerpcspe \
 	| pyramid \
 	| riscv32 | riscv64 \
 	| rl78 | rx \
@@ -373,7 +373,7 @@
 	| aarch64-* | aarch64_be-* \
 	| alpha-* | alphaev[4-8]-* | alphaev56-* | alphaev6[78]-* \
 	| alpha64-* | alpha64ev[4-8]-* | alpha64ev56-* | alpha64ev6[78]-* \
-	| alphapca5[67]-* | alpha64pca5[67]-* | arc-* | arceb-* \
+	| alphapca5[67]-* | alpha64pca5[67]-* | amd64-* | arc-* | arceb-* \
 	| arm-*  | armbe-* | armle-* | armeb-* | armv*-* \
 	| avr-* | avr32-* \
 	| be32-* | be64-* \
@@ -381,7 +381,7 @@
 	| c[123]* | c30-* | [cjt]90-* | c4x-* \
 	| c8051-* | clipper-* | craynv-* | cydra-* \
 	| d10v-* | d30v-* | dlx-* \
-	| elxsi-* \
+	| e2k-* | elxsi-* \
 	| f30[01]-* | f700-* | fido-* | fr30-* | frv-* | fx80-* \
 	| h8300-* | h8500-* \
 	| hppa-* | hppa1.[01]-* | hppa2.0-* | hppa2.0[nw]-* | hppa64-* \
@@ -426,7 +426,7 @@
 	| or1k*-* \
 	| orion-* \
 	| pdp10-* | pdp11-* | pj-* | pjl-* | pn-* | power-* \
-	| powerpc-* | powerpc64-* | powerpc64le-* | powerpcle-* \
+	| powerpc-* | powerpc64-* | powerpc64le-* | powerpcle-* | powerpcspe-* \
 	| pyramid-* \
 	| rl78-* | romp-* | rs6000-* | rx-* \
 	| sh-* | sh[1234]-* | sh[24]a-* | sh[24]aeb-* | sh[23]e-* | sh[34]eb-* | sheb-* | shbe-* \
@@ -485,12 +485,6 @@
 		basic_machine=a29k-none
 		os=-bsd
 		;;
-	amd64)
-		basic_machine=x86_64-pc
-		;;
-	amd64-*)
-		basic_machine=x86_64-`echo $basic_machine | sed 's/^[^-]*-//'`
-		;;
 	amdahl)
 		basic_machine=580-amdahl
 		os=-sysv
@@ -518,6 +512,9 @@
 		basic_machine=i386-pc
 		os=-aros
 		;;
+        asmjs)
+		basic_machine=asmjs-unknown
+		;;
 	aux)
 		basic_machine=m68k-apple
 		os=-aux
@@ -1025,7 +1022,7 @@
 		;;
 	ppc64)	basic_machine=powerpc64-unknown
 		;;
-	ppc64-* | ppc64p7-*) basic_machine=powerpc64-`echo $basic_machine | sed 's/^[^-]*-//'`
+	ppc64-*) basic_machine=powerpc64-`echo $basic_machine | sed 's/^[^-]*-//'`
 		;;
 	ppc64le | powerpc64little | ppc64-le | powerpc64-little)
 		basic_machine=powerpc64le-unknown
@@ -1373,7 +1370,7 @@
 	      | -hpux* | -unos* | -osf* | -luna* | -dgux* | -auroraux* | -solaris* \
 	      | -sym* | -kopensolaris* | -plan9* \
 	      | -amigaos* | -amigados* | -msdos* | -newsos* | -unicos* | -aof* \
-	      | -aos* | -aros* \
+	      | -aos* | -aros* | -cloudabi* \
 	      | -nindy* | -vxsim* | -vxworks* | -ebmon* | -hms* | -mvs* \
 	      | -clix* | -riscos* | -uniplus* | -iris* | -rtu* | -xenix* \
 	      | -hiux* | -386bsd* | -knetbsd* | -mirbsd* | -netbsd* \
diff -ur ../tor-0.3.0.10.orig/configure ./configure
--- ../tor-0.3.0.10.orig/configure	2017-08-01 14:39:17.000000000 -0400
+++ ./configure	2017-08-29 17:00:01.000000000 -0400
@@ -683,6 +683,8 @@
 SYSTEMD_CFLAGS
 USE_OPENBSD_MALLOC_FALSE
 USE_OPENBSD_MALLOC_TRUE
+CFI_ENABLED_FALSE
+CFI_ENABLED_TRUE
 OSS_FUZZ_ENABLED_FALSE
 OSS_FUZZ_ENABLED_TRUE
 LIBFUZZER_ENABLED_FALSE
@@ -805,6 +807,7 @@
 enable_system_torrc
 enable_libfuzzer
 enable_oss_fuzz
+enable_cfi
 enable_asciidoc
 enable_systemd
 enable_gcc_warnings
@@ -1491,6 +1494,7 @@
   --disable-system-torrc  don't look for a system-wide torrc file
   --enable-libfuzzer      build extra fuzzers based on 'libfuzzer'
   --enable-oss-fuzz       build extra fuzzers based on 'oss-fuzz' environment
+  --enable-cfi            build with non-Cross-DSO CFI
   --disable-asciidoc      don't use asciidoc (disables building of manpages)
   --enable-systemd        enable systemd notification support
   --enable-gcc-warnings   deprecated alias for enable-fatal-warnings
@@ -5088,7 +5092,12 @@
   enableval=$enable_oss_fuzz;
 fi
 
+# Check whether --enable-cfi was given.
+if test "${enable_cfi+set}" = set; then :
+  enableval=$enable_cfi;
+fi
 
+
 if test "x$enable_coverage" != "xyes" -a "x$enable_asserts_in_tests" = "xno" ; then
     as_fn_error $? "Can't disable assertions outside of coverage build" "$LINENO" 5
 fi
@@ -5133,7 +5142,15 @@
   OSS_FUZZ_ENABLED_FALSE=
 fi
 
+ if test "x$enable_cfi" = "xyes"; then
+  CFI_ENABLED_TRUE=
+  CFI_ENABLED_FALSE='#'
+else
+  CFI_ENABLED_TRUE='#'
+  CFI_ENABLED_FALSE=
+fi
 
+
 if test "$enable_static_tor" = "yes"; then
   enable_static_libevent="yes";
   enable_static_openssl="yes";
@@ -26861,6 +26878,10 @@
 fi
 if test -z "${OSS_FUZZ_ENABLED_TRUE}" && test -z "${OSS_FUZZ_ENABLED_FALSE}"; then
   as_fn_error $? "conditional \"OSS_FUZZ_ENABLED\" was never defined.
+Usually this means the macro was only invoked conditionally." "$LINENO" 5
+fi
+if test -z "${CFI_ENABLED_TRUE}" && test -z "${CFI_ENABLED_FALSE}"; then
+  as_fn_error $? "conditional \"CFI_ENABLED\" was never defined.
 Usually this means the macro was only invoked conditionally." "$LINENO" 5
 fi
 if test -z "${USE_OPENBSD_MALLOC_TRUE}" && test -z "${USE_OPENBSD_MALLOC_FALSE}"; then
diff -ur ../tor-0.3.0.10.orig/configure.ac ./configure.ac
--- ../tor-0.3.0.10.orig/configure.ac	2017-08-01 14:39:08.000000000 -0400
+++ ./configure.ac	2017-08-29 16:56:57.000000000 -0400
@@ -53,6 +53,8 @@
    AS_HELP_STRING(--enable-libfuzzer, [build extra fuzzers based on 'libfuzzer']))
 AC_ARG_ENABLE(oss-fuzz,
    AS_HELP_STRING(--enable-oss-fuzz, [build extra fuzzers based on 'oss-fuzz' environment]))
+AC_ARG_ENABLE(cfi,
+   AS_HELP_STRING(--enable-cfi, [build with non-Cross-DSO CFI]))
 
 if test "x$enable_coverage" != "xyes" -a "x$enable_asserts_in_tests" = "xno" ; then
     AC_MSG_ERROR([Can't disable assertions outside of coverage build])
@@ -63,6 +65,7 @@
 AM_CONDITIONAL(DISABLE_ASSERTS_IN_UNIT_TESTS, test "x$enable_asserts_in_tests" = "xno")
 AM_CONDITIONAL(LIBFUZZER_ENABLED, test "x$enable_libfuzzer" = "xyes")
 AM_CONDITIONAL(OSS_FUZZ_ENABLED, test "x$enable_oss_fuzz" = "xyes")
+AM_CONDITIONAL(CFI_ENABLED, test "x$enable_cfi" = "xyes")
 
 if test "$enable_static_tor" = "yes"; then
   enable_static_libevent="yes";
diff -ur ../tor-0.3.0.10.orig/depcomp ./depcomp
--- ../tor-0.3.0.10.orig/depcomp	2017-06-08 09:36:35.000000000 -0400
+++ ./depcomp	2017-08-29 17:00:03.000000000 -0400
@@ -1,9 +1,9 @@
 #! /bin/sh
 # depcomp - compile a program generating dependencies as side-effects
 
-scriptversion=2013-05-30.07; # UTC
+scriptversion=2016-01-11.22; # UTC
 
-# Copyright (C) 1999-2014 Free Software Foundation, Inc.
+# Copyright (C) 1999-2017 Free Software Foundation, Inc.
 
 # This program is free software; you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
@@ -786,6 +786,6 @@
 # eval: (add-hook 'write-file-hooks 'time-stamp)
 # time-stamp-start: "scriptversion="
 # time-stamp-format: "%:y-%02m-%02d.%02H"
-# time-stamp-time-zone: "UTC"
+# time-stamp-time-zone: "UTC0"
 # time-stamp-end: "; # UTC"
 # End:
diff -ur ../tor-0.3.0.10.orig/install-sh ./install-sh
--- ../tor-0.3.0.10.orig/install-sh	2017-06-08 09:36:35.000000000 -0400
+++ ./install-sh	2017-08-29 17:00:02.000000000 -0400
@@ -1,7 +1,7 @@
 #!/bin/sh
 # install - install a program, script, or datafile
 
-scriptversion=2013-12-25.23; # UTC
+scriptversion=2016-01-11.22; # UTC
 
 # This originates from X11R5 (mit/util/scripts/install.sh), which was
 # later released in X11R6 (xc/config/util/install.sh) with the
@@ -496,6 +496,6 @@
 # eval: (add-hook 'write-file-hooks 'time-stamp)
 # time-stamp-start: "scriptversion="
 # time-stamp-format: "%:y-%02m-%02d.%02H"
-# time-stamp-time-zone: "UTC"
+# time-stamp-time-zone: "UTC0"
 # time-stamp-end: "; # UTC"
 # End:
diff -ur ../tor-0.3.0.10.orig/missing ./missing
--- ../tor-0.3.0.10.orig/missing	2017-06-08 09:36:35.000000000 -0400
+++ ./missing	2017-08-29 17:00:02.000000000 -0400
@@ -1,9 +1,9 @@
 #! /bin/sh
 # Common wrapper for a few potentially missing GNU programs.
 
-scriptversion=2013-10-28.13; # UTC
+scriptversion=2016-01-11.22; # UTC
 
-# Copyright (C) 1996-2014 Free Software Foundation, Inc.
+# Copyright (C) 1996-2017 Free Software Foundation, Inc.
 # Originally written by Fran,cois Pinard <pinard@iro.umontreal.ca>, 1996.
 
 # This program is free software; you can redistribute it and/or modify
@@ -210,6 +210,6 @@
 # eval: (add-hook 'write-file-hooks 'time-stamp)
 # time-stamp-start: "scriptversion="
 # time-stamp-format: "%:y-%02m-%02d.%02H"
-# time-stamp-time-zone: "UTC"
+# time-stamp-time-zone: "UTC0"
 # time-stamp-end: "; # UTC"
 # End:
Only in .: orconfig.h.in~
diff -ur ../tor-0.3.0.10.orig/src/or/include.am ./src/or/include.am
--- ../tor-0.3.0.10.orig/src/or/include.am	2017-04-24 15:34:15.000000000 -0400
+++ ./src/or/include.am	2017-08-29 16:59:53.000000000 -0400
@@ -132,6 +132,11 @@
 	@TOR_LIB_WS32@ @TOR_LIB_GDI@ @CURVE25519_LIBS@ @TOR_SYSTEMD_LIBS@
 endif
 
+if CFI_ENABLED
+src_or_tor_CFLAGS = -flto -fvisibility=hidden -fsanitize=cfi
+src_or_tor_LDFLAGS += -flto -fvisibility=hidden -fsanitize=cfi
+endif
+
 ORHEADERS = \
 	src/or/addressmap.h				\
 	src/or/bridges.h				\
diff -ur ../tor-0.3.0.10.orig/test-driver ./test-driver
--- ../tor-0.3.0.10.orig/test-driver	2017-06-08 09:36:36.000000000 -0400
+++ ./test-driver	2017-08-29 17:00:03.000000000 -0400
@@ -1,9 +1,9 @@
 #! /bin/sh
 # test-driver - basic testsuite driver script.
 
-scriptversion=2013-07-13.22; # UTC
+scriptversion=2016-01-11.22; # UTC
 
-# Copyright (C) 2011-2014 Free Software Foundation, Inc.
+# Copyright (C) 2011-2017 Free Software Foundation, Inc.
 #
 # This program is free software; you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
@@ -143,6 +143,6 @@
 # eval: (add-hook 'write-file-hooks 'time-stamp)
 # time-stamp-start: "scriptversion="
 # time-stamp-format: "%:y-%02m-%02d.%02H"
-# time-stamp-time-zone: "UTC"
+# time-stamp-time-zone: "UTC0"
 # time-stamp-end: "; # UTC"
 # End:
