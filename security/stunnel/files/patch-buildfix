--- ChangeLog.orig	2015-12-11 11:15:13 UTC
+++ ChangeLog
@@ -1,5 +1,9 @@
 stunnel change log
 
+Version 5.28, unreleased, urgency: LOW
+* Bugfixes
+  - Compilation fix for *BSD.
+
 Version 5.28, 2015.12.11, urgency: HIGH
 * New features
   - Build matrix (.travis.yml) extended with ./configure options.
--- configure.orig	2015-12-08 15:59:04 UTC
+++ configure
@@ -3077,20 +3077,6 @@ END
 fi
 
 
-$as_echo "#define _GNU_SOURCE 1" >>confdefs.h
-
-
-$as_echo "#define _DARWIN_C_SOURCE 1" >>confdefs.h
-
-# OSX does not declare chroot() with newer _XOPEN_SOURCE versions
-
-$as_echo "#define _XOPEN_SOURCE 500" >>confdefs.h
-
-# Solaris does not declare IPv6 structures without __EXTENSIONS__
-
-$as_echo "#define __EXTENSIONS__ 1" >>confdefs.h
-
-
  if test -d ".git"; then
   AUTHOR_TESTS_TRUE=
   AUTHOR_TESTS_FALSE='#'
@@ -3190,6 +3176,24 @@ cat >>confdefs.h <<_ACEOF
 _ACEOF
 
 
+case "$host_os" in
+*darwin*)
+    # OSX does not declare ucontext without _XOPEN_SOURCE
+
+$as_echo "#define _XOPEN_SOURCE 500" >>confdefs.h
+
+    # OSX does not declare chroot() without _DARWIN_C_SOURCE
+
+$as_echo "#define _DARWIN_C_SOURCE 1" >>confdefs.h
+
+    ;;
+*)
+
+$as_echo "#define _GNU_SOURCE 1" >>confdefs.h
+
+    ;;
+esac
+
 ac_ext=c
 ac_cpp='$CPP $CPPFLAGS'
 ac_compile='$CC -c $CFLAGS $CPPFLAGS conftest.$ac_ext >&5'
--- configure.ac.orig	2015-12-08 15:58:38 UTC
+++ configure.ac
@@ -7,12 +7,6 @@ AC_CONFIG_MACRO_DIR([m4])
 AC_CONFIG_HEADERS([src/config.h])
 AC_CONFIG_SRCDIR([src/stunnel.c])
 AM_INIT_AUTOMAKE
-AC_DEFINE([_GNU_SOURCE], [1], [Use GNU source])
-AC_DEFINE([_DARWIN_C_SOURCE], [1], [Use Darwin source])
-# OSX does not declare chroot() with newer _XOPEN_SOURCE versions
-AC_DEFINE([_XOPEN_SOURCE], [500], [Use X/Open 5 with POSIX 1995])
-# Solaris does not declare IPv6 structures without __EXTENSIONS__
-AC_DEFINE([__EXTENSIONS__], [1], [Use extended system interfaces])
 
 AM_CONDITIONAL([AUTHOR_TESTS], [test -d ".git"])
 AC_CANONICAL_HOST
@@ -23,6 +17,18 @@ AC_DEFINE_UNQUOTED(esc(CPU_$host_cpu))
 AC_DEFINE_UNQUOTED(esc(VENDOR_$host_vendor))
 AC_DEFINE_UNQUOTED(esc(OS_$host_os))
 
+case "$host_os" in
+*darwin*)
+    # OSX does not declare ucontext without _XOPEN_SOURCE
+    AC_DEFINE([_XOPEN_SOURCE], [500], [Use X/Open 5 with POSIX 1995])
+    # OSX does not declare chroot() without _DARWIN_C_SOURCE
+    AC_DEFINE([_DARWIN_C_SOURCE], [1], [Use Darwin source])
+    ;;
+*)
+    AC_DEFINE([_GNU_SOURCE], [1], [Use GNU source])
+    ;;
+esac
+
 AC_PROG_CC
 AM_PROG_CC_C_O
 AC_PROG_INSTALL
--- src/config.h.in.orig	2015-12-08 15:59:16 UTC
+++ src/config.h.in
@@ -290,9 +290,6 @@
 /* Use X/Open 5 with POSIX 1995 */
 #undef _XOPEN_SOURCE
 
-/* Use extended system interfaces */
-#undef __EXTENSIONS__
-
 /* Define to `int' if <sys/types.h> doesn't define. */
 #undef gid_t
 
--- src/dhparam.c.orig	2015-12-05 21:51:48 UTC
+++ src/dhparam.c
@@ -2,44 +2,52 @@
 #ifndef OPENSSL_NO_DH
 #define DN_new DH_new
 #ifndef HEADER_DH_H
-#include <openssl/dh.h>
+# include <openssl/dh.h>
 #endif
+
 DH *get_dh2048()
-	{
-	static unsigned char dh2048_p[]={
-		0xC8,0xB6,0xC5,0xB3,0x5B,0x11,0xA6,0xA3,0x5B,0xAF,0x6E,0x47,
-		0x48,0x68,0x54,0x5D,0x17,0xE1,0x05,0xA2,0x04,0x71,0xD7,0xA1,
-		0xD4,0xD4,0xC4,0x46,0x6F,0x1C,0x95,0xC6,0xFE,0xF2,0xAD,0xDC,
-		0xEB,0x97,0x95,0x97,0x52,0x15,0x39,0xDC,0xE7,0x5D,0x59,0xC2,
-		0xA9,0x31,0x74,0x08,0x31,0xF7,0xD8,0xFF,0xF3,0xEC,0xE9,0xE7,
-		0xA1,0xC0,0xCC,0x2B,0x0E,0x45,0x56,0x06,0x64,0xE2,0x75,0x51,
-		0xBB,0x20,0xF9,0x7F,0x0C,0xD6,0x92,0xA5,0x76,0x87,0x4D,0x74,
-		0xEE,0x70,0x15,0x1F,0xE9,0x51,0x9E,0xB4,0xBF,0xEF,0xBE,0x22,
-		0xAC,0x0E,0x5F,0xE3,0x23,0x74,0x28,0xFC,0x00,0x7E,0xE7,0x5B,
-		0x14,0x00,0x1E,0x36,0xB6,0xE0,0x7F,0x35,0xF5,0x5F,0xE6,0x98,
-		0xCC,0xE4,0x35,0xC8,0x67,0x5F,0xDA,0x4B,0x81,0xA3,0xC2,0xE8,
-		0x20,0x7B,0xFF,0x25,0xE0,0x24,0x6A,0xB2,0x2C,0xE3,0xC8,0x2E,
-		0xAA,0x66,0xAE,0xB5,0x02,0xB2,0x77,0x7B,0x6B,0xCD,0xF1,0x1E,
-		0xF7,0xDD,0x93,0x7C,0xC2,0xAC,0x17,0x63,0x6E,0x08,0x1F,0x06,
-		0xB5,0x54,0x58,0xDC,0xC0,0x91,0x6F,0xE8,0xC8,0xC8,0xB0,0x58,
-		0x6D,0x90,0xF0,0x34,0xB3,0x98,0xCC,0x02,0x52,0xAF,0xA5,0xD3,
-		0x44,0x1C,0xC8,0x99,0x0F,0xF2,0x76,0x71,0x2A,0x22,0x58,0x05,
-		0xE3,0x2A,0xFF,0xFA,0xCF,0x02,0x50,0x38,0x74,0xE8,0xE7,0x87,
-		0xB5,0x13,0x0A,0xAC,0x21,0x87,0x53,0xBB,0xFE,0x7A,0x38,0x0E,
-		0x37,0xAB,0xAB,0xB7,0x77,0xDD,0x16,0x7E,0xCA,0x1D,0xD7,0xB2,
-		0x81,0x11,0x4E,0x9C,0xBF,0x0B,0xAA,0x41,0xA1,0x6A,0x30,0x18,
-		0xC9,0xD4,0x1B,0xB3,
-		};
-	static unsigned char dh2048_g[]={
-		0x02,
-		};
-	DH *dh;
+{
+    static unsigned char dhp_2048[] = {
+	0xB6, 0x05, 0xE1, 0x2B, 0x14, 0x50, 0x56, 0xE3, 0x1D, 0xD3, 
+	0xCA, 0x29, 0x55, 0x4C, 0xFF, 0x66, 0xF1, 0x6E, 0xA7, 0xF6, 
+	0x12, 0x4C, 0x43, 0x15, 0x53, 0x73, 0x3F, 0xEA, 0xE9, 0xDC, 
+	0xA5, 0x2D, 0x52, 0xA5, 0xE6, 0xCB, 0xCE, 0x7F, 0xC0, 0xBA, 
+	0x7F, 0x1B, 0xE4, 0xD6, 0xDD, 0x11, 0x6B, 0x9B, 0x01, 0x3D, 
+	0xA8, 0xF7, 0x91, 0xB4, 0xE9, 0x3C, 0x00, 0xE4, 0xDA, 0x92, 
+	0xA3, 0xA7, 0xBB, 0xA0, 0xB1, 0x9D, 0x6D, 0xE8, 0x7C, 0xD2, 
+	0x6C, 0xEF, 0xAB, 0x95, 0x85, 0x6E, 0xFB, 0xC1, 0x4D, 0x19, 
+	0x55, 0x7D, 0xBA, 0xD4, 0x36, 0xED, 0x75, 0x88, 0xCA, 0x5F, 
+	0xE8, 0x8A, 0x38, 0x05, 0xDB, 0xB1, 0x71, 0x14, 0xD7, 0x39, 
+	0x8D, 0xA4, 0xDA, 0x40, 0x29, 0x50, 0x55, 0x32, 0xEA, 0xFA, 
+	0x04, 0x31, 0xC5, 0xC0, 0x18, 0x89, 0x5F, 0xF2, 0x2A, 0x19, 
+	0x36, 0x1A, 0x86, 0xB8, 0xC7, 0xF8, 0x4A, 0x5F, 0xC8, 0xD8, 
+	0x5A, 0x15, 0x92, 0x94, 0x84, 0x0B, 0xB7, 0x5F, 0x33, 0xAD, 
+	0x08, 0xCB, 0x4D, 0x73, 0x54, 0x9A, 0xE6, 0xD9, 0x54, 0x61, 
+	0x4A, 0xB2, 0x4E, 0xBE, 0x07, 0x10, 0x77, 0x5C, 0x7C, 0x42, 
+	0x6A, 0xE3, 0x91, 0xF2, 0xA9, 0x71, 0xE2, 0x45, 0x36, 0xCF, 
+	0x5B, 0x3B, 0x29, 0xF8, 0x2B, 0x49, 0x0E, 0xD0, 0x1E, 0xA4, 
+	0x53, 0x1D, 0x89, 0x16, 0xFB, 0xC6, 0xB5, 0x28, 0xFD, 0xC6, 
+	0x2E, 0xAB, 0xC2, 0xD5, 0xBA, 0x7D, 0xD5, 0x35, 0x91, 0xE4, 
+	0xED, 0xA8, 0x55, 0x8C, 0xFC, 0x5B, 0x1E, 0x97, 0x52, 0x9D, 
+	0x33, 0xD8, 0xEE, 0xC2, 0x96, 0xCF, 0x28, 0xB4, 0x40, 0xD1, 
+	0x6C, 0xF7, 0xF5, 0x97, 0x69, 0x86, 0x69, 0x86, 0x67, 0x52, 
+	0xFB, 0x84, 0x6C, 0x4B, 0xE5, 0xD6, 0xE3, 0x4C, 0xB6, 0xDF, 
+	0x17, 0xE7, 0xD3, 0x14, 0x09, 0xEE, 0xA2, 0x84, 0x0C, 0x2A, 
+	0xD6, 0xFD, 0x58, 0xD5, 0xE7, 0xCB
+    };
+    static unsigned char dhg_2048[] = {
+	0x02
+    };
+    DH *dh = DN_new();
 
-	if ((dh=DH_new()) == NULL) return(NULL);
-	dh->p=BN_bin2bn(dh2048_p,sizeof(dh2048_p),NULL);
-	dh->g=BN_bin2bn(dh2048_g,sizeof(dh2048_g),NULL);
-	if ((dh->p == NULL) || (dh->g == NULL))
-		{ DH_free(dh); return(NULL); }
-	return(dh);
-	}
+    if (dh == NULL)
+        return NULL;
+    dh->p = BN_bin2bn(dhp_2048, sizeof (dhp_2048), NULL);
+    dh->g = BN_bin2bn(dhg_2048, sizeof (dhg_2048), NULL);
+    if (!dh->p || !dh->g) {
+        DH_free(dh);
+        return NULL;
+    }
+    return dh;
+}
 #endif /* OPENSSL_NO_DH */
