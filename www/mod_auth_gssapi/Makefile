PORTNAME=	mod_auth_gssapi
DISTVERSIONPREFIX=	v
DISTVERSION=	1.6.5
PORTREVISION=	1
CATEGORIES=	www
PKGNAMEPREFIX=	${APACHE_PKGNAMEPREFIX}

MAINTAINER=	chris@chrullrich.net
COMMENT=	Apache module for authenticating users with GSSAPI
WWW=		https://github.com/gssapi/mod_auth_gssapi

LICENSE=	MIT
LICENSE_FILE=	${WRKSRC}/COPYING

USES=		autoreconf apache bison libtool pkgconfig ssl
USE_GITHUB=	yes
GH_ACCOUNT=	gssapi
GNU_CONFIGURE=	yes
CONFIGURE_ARGS=	KRB5_CONFIG=${KRB5CONFIG} \
		OPENSSL_CFLAGS=-I${OPENSSLINC} \
		OPENSSL_LIBS=-lcrypto

APMOD_FILE=	240_${PORTNAME}.conf.sample
SUB_FILES=	${APMOD_FILE}
PLIST_FILES=	@sample\ ${APACHEETCDIR}/modules.d/${APMOD_FILE} \
		${APACHEMODDIR}/mod_auth_gssapi.so
PLIST_SUB=	APMOD_FILE=${APMOD_FILE}

OPTIONS_DEFAULT=		${OPTIONS_DEFAULT_${OPSYS}_${OSREL:R}}
OPTIONS_DEFAULT_FreeBSD_13=	GSSAPI_MIT
OPTIONS_DEFAULT_FreeBSD_14=	GSSAPI_MIT
OPTIONS_DEFAULT_FreeBSD_15=	GSSAPI_BASE
OPTIONS_DEFAULT_FreeBSD_16=	GSSAPI_BASE
OPTIONS_SINGLE=			GSSAPI
OPTIONS_SINGLE_GSSAPI=		GSSAPI_BASE GSSAPI_MIT
OPTIONS_EXCLUDE_FreeBSD_13=	GSSAPI_BASE
OPTIONS_EXCLUDE_FreeBSD_14=	GSSAPI_BASE

GSSAPI_BASE_USES=	gssapi:flags
GSSAPI_MIT_USES=	gssapi:mit,flags

.include <bsd.port.options.mk>

.if ${PORT_OPTIONS:MGSSAPI_BASE} && ${OPSYS} == FreeBSD && ${OSVERSION} < 1500054
IGNORE=		the GSSAPI_BASE option needs MIT Kerberos in base
.endif

do-install:
	@${MKDIR} ${STAGEDIR}${PREFIX}/${APACHEMODDIR} \
		  ${STAGEDIR}${PREFIX}/${APACHEETCDIR}/modules.d
	${APXS} -S LIBEXECDIR=${STAGEDIR}${PREFIX}/${APACHEMODDIR} \
		-i -n ${MODULENAME} ${WRKSRC}/src/${MODULENAME}.la
	${INSTALL_DATA} ${WRKDIR}/${APMOD_FILE} ${STAGEDIR}${PREFIX}/${APACHEETCDIR}/modules.d
	${STRIP_CMD} ${STAGEDIR}${PREFIX}/${APACHEMODDIR}/${MODULENAME}.so

.include <bsd.port.mk>
