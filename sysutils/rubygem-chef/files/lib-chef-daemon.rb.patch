--- lib/chef/daemon.rb.orig	2012-09-05 11:19:47.000000000 +0900
+++ lib/chef/daemon.rb	2012-09-05 11:22:42.000000000 +0900
       # nil::
       #   Returned if the pid_file does not exist.
       #
-      def pid_from_file
-        File.read(pid_file).chomp.to_i
-      rescue Errno::ENOENT, Errno::EACCES
-        nil
+      def read_pid_file
+        @fh = File.open(pid_file, File::RDWR|File::CREAT, 0644)
+        @fh.flock(File::LOCK_EX | File::LOCK_NB) || Chef::Application.fatal!("Couldn't lock pidfile #{pid_file}")
+        pid = @fh.read.chomp
+        if pid =~ /^\d+/
+          @pid = pid.to_i
+        else
+          @pid = nil
+        end        
+      rescue Errno::EACCES => e
+        Chef::Application.fatal!("You don't have access to the PID file at #{pid_file}: #{e.message}")
+      rescue Errno::ENOENT
+        @pid = nil
       end
     
       # Store the PID on the filesystem
