# $FreeBSD$

PORTNAME=	rundeck
DISTVERSION=	3.3.10
DISTVERSIONSUFFIX=	20210301
CATEGORIES=	sysutils java
MASTER_SITES=	https://dl.bintray.com/rundeck/rundeck-maven/org/rundeck/rundeck/ \
		https://download.rundeck.org/war/
PKGNAMESUFFIX=	3
DISTNAME=	${PORTNAME}-${DISTVERSION}-${DISTVERSIONSUFFIX}
EXTRACT_SUFX=	.war

MAINTAINER=	daniel.tihanyi@tetragir.com
COMMENT=	Web-console for dispatching commands and scripts to your nodes

LICENSE=	APACHE20

USE_JAVA=	yes
JAVA_VERSION=	8 11

CONFLICTS_INSTALL=	rundeck2

NO_ARCH=	yes
NO_BUILD=	yes

USE_RC_SUBR=	rundeck

RUNDECK_HOME=	${PREFIX}/rundeck
RUNDECK_USER?=	rundeck
RUNDECK_GROUP?=	rundeck
RUNDECK_LOGDIR?=	/var/log/rundeck
RUNDECK_LOG_FILE?=	${RUNDECK_LOGDIR}/rundeck.log
RUNDECK_LOG4J=	log4j2.properties
RUNDECK_CONFIG_DIR=	${RUNDECK_HOME}/server/config

.if ${RUNDECK_USER} == "rundeck"
USERS=	rundeck
.endif
.if ${RUNDECK_GROUP} == "rundeck"
GROUPS=	rundeck
.endif

PLIST_SUB=	RUNDECK_USER=${RUNDECK_USER} RUNDECK_GROUP=${RUNDECK_GROUP} \
		RUNDECK_LOGDIR=${RUNDECK_LOGDIR} RUNDECK_HOME=${RUNDECK_HOME}

SUB_FILES=	${RUNDECK_LOG4J}
SUB_LIST+=	RUNDECK_HOME=${RUNDECK_HOME} RUNDECK_USER=${RUNDECK_USER} \
		RUNDECK_GROUP=${RUNDECK_GROUP} JAVA_HOME=${JAVA_HOME} \
		RUNDECK_LOG_FILE=${RUNDECK_LOG_FILE} \
		RUNDECK_LOG4J=${RUNDECK_LOG4J} \
		RUNDECK_CONFIG_DIR=${RUNDECK_CONFIG_DIR} \
		RUNDECK_LOGDIR=${RUNDECK_LOGDIR}

do-install:
	${MKDIR} ${STAGEDIR}${DATADIR} ${STAGEDIR}${RUNDECK_HOME}/server/lib
	${MKDIR} ${STAGEDIR}${RUNDECK_LOGDIR}
	${INSTALL_DATA} ${DISTDIR}/${DIST_SUBDIR}/${DISTNAME}${EXTRACT_SUFX} \
		${STAGEDIR}${DATADIR}/rundeck${EXTRACT_SUFX}

post-install:
	${MKDIR} ${STAGEDIR}${RUNDECK_CONFIG_DIR}
	${INSTALL_DATA} \
		${WRKDIR}/${RUNDECK_LOG4J} \
		${STAGEDIR}${RUNDECK_CONFIG_DIR}/${RUNDECK_LOG4J}

.include <bsd.port.mk>
