# New ports collection makefile for:    logstash
# Date created:         10 May 2013
# Whom:			Daniel Solsona <daniel@ish.com.au> et al.
#
# $FreeBSD$
#

# TODO
# - DOCs
# 
PORTNAME=	logstash
PORTVERSION=	1.1.12
PORTREVISION=	4
CATEGORIES=	sysutils java
MASTER_SITES=	https://logstash.objects.dreamhost.com/release/
DISTNAME=	${PORTNAME}-${PORTVERSION}-flatjar
EXTRACT_SUFX=	.jar
EXTRACT_ONLY=

MAINTAINER=	daniel@ish.com.au
COMMENT=	Tool for managing events and logs

USE_JAVA=	yes
JAVA_VERSION=	1.7+

NO_BUILD=	yes

USE_RC_SUBR=	logstash
USERS=	${PORTNAME}
GROUPS=	${PORTNAME}

LOGSTASH_HOME?=	${PREFIX}/${PORTNAME}
LOGSTASH_HOME_REL?=	${LOGSTASH_HOME:S,^${PREFIX}/,,}
LOGSTASH_JAR?=	${DISTNAME}${EXTRACT_SUFX}
LOGSTASH_RUN?=	/var/run/${PORTNAME}
LOGSTASH_DATA_DIR?=	/var/db/${PORTNAME}

SUB_LIST=	LOGSTASH_DATA_DIR=${LOGSTASH_DATA_DIR} JAVA_HOME=${JAVA_HOME} \
		LOGSTASH_HOME=${LOGSTASH_HOME} LOGSTASH_JAR=${LOGSTASH_JAR}
PLIST_SUB+=	LOGSTASH_HOME=${LOGSTASH_HOME_REL} LOGSTASH_JAR=${LOGSTASH_JAR} \
		LOGSTASH_RUN=${LOGSTASH_RUN} \
		LOGSTASH_DATA_DIR=${LOGSTASH_DATA_DIR}

do-patch:
	/usr/bin/bspatch ${DISTDIR}/${DIST_SUBDIR}/${LOGSTASH_JAR} \
		${WRKDIR}/${LOGSTASH_JAR}.patched \
		${FILESDIR}/view_fix.patch
do-install:
	${MKDIR} ${LOGSTASH_RUN}
	${MKDIR} ${ETCDIR}
	${MKDIR} ${LOGSTASH_HOME}
	${MKDIR} ${LOGSTASH_DATA_DIR}
	${INSTALL_DATA} ${WRKDIR}/${LOGSTASH_JAR}.patched ${LOGSTASH_HOME}/${LOGSTASH_JAR}
	${INSTALL_DATA} ${FILESDIR}/logstash.conf.sample ${ETCDIR}
	@if [ ! -f ${ETCDIR}/logstash.conf ]; then \
		${CP} -p ${ETCDIR}/logstash.conf.sample ${ETCDIR}/logstash.conf ; \
	fi
	${INSTALL_DATA} ${FILESDIR}/elasticsearch.yml.sample ${ETCDIR}
	@if [ ! -f ${ETCDIR}/elasticsearch.yml ]; then \
		${CP} -p ${ETCDIR}/elasticsearch.yml.sample ${ETCDIR}/elasticsearch.yml ; \
	fi

.include <bsd.port.mk>
