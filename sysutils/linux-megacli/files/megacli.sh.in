#!/bin/sh

# check for root user
#
if [ `id -u` -ne 0 ]
then
	echo "You must be root to run `basename $0`." >&2
	exit 1
fi

if ! [ `sysctl -n compat.linux.osrelease` = "2.6.12" ]; then
	echo "You need to set compat.linux.osrelease to 2.6.12 to run `basename $0`." >&2
	exit 1
fi

lpfs=`mount -t linprocfs | wc -l | awk '{ print $1 }'`
if [ ${lpfs} -le 0 ]; then
	echo "You need to mount linprocfs to run `basename $0`." >&2
	exit 1
fi
lsfs=`mount -t linsysfs | wc -l | awk '{ print $1 }'`
if [ ${lsfs} -le 0 ]; then
	echo "You need to mount linsysfs to run `basename $0`." >&2
	exit 1
fi

# check for active mfi_linux.ko
#
if ! kldstat -q -m mfi_linux
then
	if kldload mfi_linux
	then
		echo 'mfi_linux module loaded.' >&2
	else
		echo 'mfi_linux module failed to load.' >&2
		exit 1
	fi
fi

if [ $# -le 0 ]; then
	echo "usage: `basename $0` [options]" >&2
	exec %%PREFIX%%/libexec/MegaCli -h
fi

exec %%PREFIX%%/libexec/MegaCli ${*}
