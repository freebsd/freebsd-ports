#!/bin/sh
#
# $FreeBSD$
#

# PROVIDE: %%PORTNAME%%
# REQUIRE: LOGIN
# KEYWORD: shutdown

#
# Add the following lines to /etc/rc.conf to enable %%PORTNAME%%:
#
# %%PORTNAME%%_enable="YES"
# %%PORTNAME%%_flags="<set as needed>"
#

. %%RC_SUBR%%

name=%%PORTNAME%%
start_precmd="%%PORTNAME%%_start_precmd"
stop_postcmd="%%PORTNAME%%_stop_postcmd"
rcvar=`set_rcvar`

command=%%PREFIX%%/%%SLIMDIR%%/slimserver.pl
command_interpreter=%%PERL%%
pidfile=/var/run/${name}/${name}.pid
logdir=/var/log/${name}
statedir=%%SLIMDBDIR%%
cachedir=${statedir}/cache
prefsdir=${statedir}/prefs
playlistdir=${statedir}/playlists
conffile=${statedir}/${name}.conf
u=%%SLIMUSER%%
g=%%SLIMGROUP%%
command_args="--daemon --prefsfile=${conffile} --pidfile=${pidfile}"
%%PORTNAME%%_user=${u}
%%PORTNAME%%_group=${g}

%%PORTNAME%%_start_precmd()
{
	mkdir -p /var/run/${name}
	chown -RH ${u}:${g} /var/run/${name}

	mkdir -p ${logdir}
	chown -RH ${u}:${g} ${logdir}

	mkdir -p ${statedir}
	mkdir -p ${cachedir}
	mkdir -p ${prefsdir}
	mkdir -p ${playlistdir}
	touch ${conffile}
	chown -RH ${u}:${g} ${statedir}

	if [ ! -f ${logfile} ]; then
		touch ${logfile}
		chown -H ${u}:${g} ${logfile}
	fi	
}

%%PORTNAME%%_stop_postcmd()
{
	pids=`pgrep -u $u`
	if [ -n "${pids}" ]; then
		sleep 1
		kill $pids > /dev/null 2>&1
	fi
	pids=`pgrep -u $u`
	if [ -n "${pids}" ]; then
		wait_for_pids $pids
	fi
}

load_rc_config ${name}

%%PORTNAME%%_enable=${%%PORTNAME%%_enable:-"NO"}

run_rc_command "$1"
