# Created by: Olexander Melnyk <olexander.v.melnyk@gmail.com>
# $FreeBSD$

PORTNAME=	luadbi
PORTVERSION=	0.5
PORTREVISION=	3
CATEGORIES=	databases
MASTER_SITES=	http://ic.km.ua/~old/luadbi/
PKGNAMEPREFIX=	${LUA_PKGNAMEPREFIX}
DISTNAME=	${PORTNAME}-${PORTVERSION}.f562ccd

MAINTAINER=	olexander.v.melnyk@gmail.com
COMMENT=	LuaDBI driver

LICENSE=	MIT

WRKSRC=		${WRKDIR}/${PORTNAME}-master

USES=		gmake shebangfix zip
SHEBANG_FILES=	DBI.lua

CFLAGS+=	-fpic -I${LOCALBASE}/include -I${LUA_INCDIR} -I. \
		-I${LOCALBASE}/include/postgresql/server
LDFLAGS+=	-shared -L${LOCALBASE}/lib -L${LUA_LIBDIR}
MAKE_ENV+=	COMMON_LDFLAGS="${LDFLAGS}"

MAKE_JOBS_UNSAFE=yes

OPTIONS_SINGLE=	LUA_VERSION
OPTIONS_SINGLE_LUA_VERSION=	LUA51 LUA52
OPTIONS_MULTI=	DATABASE
OPTIONS_MULTI_DATABASE=	MYSQL SQLITE3 PGSQL
OPTIONS_DEFAULT=	MYSQL LUA52

PLIST_FILES=	%%LUA_MODSHAREDIR%%/DBI.lua

LUA51_USES=	lua:51

LUA52_USES=	lua:52

MYSQL_USES=		mysql
MYSQL_LDFLAGS=		-L ${LOCALBASE}/lib/mysql
MYSQL_CFLAGS=		-I ${LOCALBASE}/include/mysql
MYSQL_ALL_TARGET=	mysql
MYSQL_PLIST_FILES=	%%LUA_MODLIBDIR%%/dbdmysql.so

SQLITE3_USES=		sqlite:3
SQLITE3_ALL_TARGET=	sqlite3
SQLITE3_PLIST_FILES=	%%LUA_MODLIBDIR%%/dbdsqlite3.so

PGSQL_USES=		pgsql
PGSQL_ALL_TARGET=	psql
PGSQL_PLIST_FILES=	%%LUA_MODLIBDIR%%/dbdpostgresql.so
PGSQL_BROKEN=		Not tested

do-install:
	@${MKDIR} ${STAGEDIR}${LUA_MODLIBDIR}
	@${MKDIR} ${STAGEDIR}${LUA_MODSHAREDIR}
	${CP} ${WRKSRC}/DBI.lua ${STAGEDIR}${LUA_MODSHAREDIR}

do-install-MYSQL-on:
	${INSTALL_PROGRAM} ${WRKSRC}/dbdmysql.so ${STAGEDIR}${LUA_MODLIBDIR}

do-install-SQLITE3-on:
	${INSTALL_PROGRAM} ${WRKSRC}/dbdsqlite3.so ${STAGEDIR}${LUA_MODLIBDIR}

do-install-PGSQL-on:
	${INSTALL_PROGRAM} ${WRKSRC}/dbdpostgresql.so ${STAGEDIR}${LUA_MODLIBDIR}

.include <bsd.port.mk>
