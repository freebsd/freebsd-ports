#!/bin/sh
# $FreeBSD$

if [ -f ${WRKDIRPREFIX}${CURDIR}/Makefile.inc ]; then
	exit
fi

tempfile=`mktemp -t checklist`

if [ "${NAGIOS_PLUGINS_OPTIONS}" ]; then
	set ${NAGIOS_PLUGINS_OPTIONS}
fi

for i; do
	eval status_$i=ON
done
	
if [ -z "${BATCH}" ]; then
	/usr/bin/dialog --title "Nagios plugins configuration options" --clear \
			--checklist "\n\
Please select desired options:" -1 -1 16 \
QStat	"Game server query support" "$status_QStat" \
FPing	"Support for non-flooding fast ping" "$status_FPing" \
NetSNMP	"SNMP support" "$status_NetSNMP" \
Radius	"Radius support" "$status_Radius" \
MySQL	"MySQL support" "$status_MySQL" \
PgSQL	"PostgreSQL support" "$status_PgSQL" \
OpenLDAP	"OpenLDAP support" "$status_OpenLDAP" \
2> $tempfile

	retval=$?

	if [ -s $tempfile ]; then
		set `sed 's/"//g' $tempfile`
	fi
	rm -f $tempfile

	case $retval in
		0)	if [ -z "$*" ]; then
				echo "Nothing selected"
			fi
			;;
		1)	echo "Cancel pressed."
			exit 1
			;;
	esac
fi

${MKDIR} ${WRKDIRPREFIX}${CURDIR}
exec > ${WRKDIRPREFIX}${CURDIR}/Makefile.inc

echo "PREFIX=   ${PREFIX}"

SUB_QSTAT="@comment "
SUB_FPING="@comment "
SUB_SNMP="@comment "
SUB_RADIUS="@comment "
SUB_MYSQL="@comment "
SUB_PGSQL="@comment "
SUB_LDAP="@comment "

while [ "$1" ]; do
	case $1 in
		QStat)
			echo "BUILD_DEPENDS+=	qstat:\${PORTSDIR}/games/qstat"
			echo "RUN_DEPENDS+=	qstat:\${PORTSDIR}/games/qstat"
			echo "CONFIGURE_ARGS+=	--enable-qstat"
			SUB_QSTAT=""
			;;
		FPing)
			echo "BUILD_DEPENDS+=	fping:\${PORTSDIR}/net/fping"
			echo "RUN_DEPENDS+=	fping:\${PORTSDIR}/net/fping"
			echo "CONFIGURE_ARGS+=	--enable-fping"
			SUB_FPING=""
			;;
		NetSNMP)
			echo "BUILD_DEPENDS+=	snmpcheck:\${PORTSDIR}/net-mgmt/net-snmp"
			echo "RUN_DEPENDS+=	snmpcheck:\${PORTSDIR}/net-mgmt/net-snmp"
			echo "BUILD_DEPENDS+=	\${LOCALBASE}/lib/perl5/site_perl/\${PERL_VER}/Net/SNMP.pm:\${PORTSDIR}/net-mgmt/p5-Net-SNMP"
			echo "RUN_DEPENDS+=	\${LOCALBASE}/lib/perl5/site_perl/\${PERL_VER}/Net/SNMP.pm:\${PORTSDIR}/net-mgmt/p5-Net-SNMP"
			echo "CONFIGURE_ARGS+=	--enable-snmp"
			SUB_SNMP=""
			;;
		Radius)
			echo "LIB_DEPENDS+=	radiusclient.0:\${PORTSDIR}/net/radiusclient"
			echo "CONFIGURE_ARGS+=	--enable-radius"
			SUB_RADIUS=""
			;;
		MySQL)
			echo ".if exists(${LOCALBASE}/lib/mysql/libmysqlclient.so.12)"
			echo "LIB_DEPENDS+=	mysqlclient.12:${PORTSDIR}/databases/mysql40-client"
			echo ".else"
			echo ".if exists(${LOCALBASE}/lib/mysql/libmysqlclient.so.14)"
			echo "LIB_DEPENDS+=	mysqlclient.14:${PORTSDIR}/databases/mysql41-client"
			echo ".else"
			echo "LIB_DEPENDS+=	mysqlclient.10:${PORTSDIR}/databases/mysql323-client"
			echo ".endif"
			echo ".endif"
			echo "CONFIGURE_ARGS+=	--with-mysql=\${LOCALBASE}"
			SUB_MYSQL=""
			;;
		PgSQL)
			echo "POSTGRESQL_PORT?=	databases/postgresql7"
			echo "LIB_DEPENDS+=	pq.3:\${PORTSDIR}/\${POSTGRESQL_PORT}"
			echo "CONFIGURE_ARGS+=	--with-pgsql=\${LOCALBASE}"
			SUB_PGSQL=""
			;;
		OpenLDAP)
			echo "LIB_DEPENDS+=	ldap.2:\${PORTSDIR}/net/openldap20-client"
			echo "CONFIGURE_ARGS+=	--enable-ldap"
			SUB_LDAP=""
			;;
		*)
			echo "Unknown option(s): $*" > /dev/stderr
			rm -f ${WRKDIRPREFIX}${CURDIR}/Makefile.inc
			exit 1
			;;
	esac
	shift
done

echo "PLIST_SUB+=	SUB_QSTAT=\"${SUB_QSTAT}\""
echo "PLIST_SUB+=	SUB_FPING=\"${SUB_FPING}\""
echo "PLIST_SUB+=	SUB_SNMP=\"${SUB_SNMP}\""
echo "PLIST_SUB+=	SUB_RADIUS=\"${SUB_RADIUS}\""
echo "PLIST_SUB+=	SUB_MYSQL=\"${SUB_MYSQL}\""
echo "PLIST_SUB+=	SUB_PGSQL=\"${SUB_PGSQL}\""
echo "PLIST_SUB+=	SUB_LDAP=\"${SUB_LDAP}\""
